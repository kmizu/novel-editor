# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 重要な指示

**日本語で応答してください。**

**注意深く、用心深くコーディングをしてください。**

**問題が起きたときにパニックにならないでください。**

**作業を進める際は、以下の点を説明しながら実装してください：**

- なぜその技術・ライブラリを選択したのか
- 実装の手順と意図
- コードの構造とその理由
- テストの重要性と実装方法

**作業完了前の確認事項：**
各フェーズやタスクの完了を報告する前に、必ず以下を確認してください：

1. `npm run build` - ビルドが成功すること
2. `npm run type-check` - 型エラーがないこと
3. `npm run lint` - リントエラーがないこと
4. `npm run test` - 全てのテストが通ること
5. `npm run dev` - 開発サーバーが正常に起動すること

**重要：各ステップの作業が完了したら、必ずCLAUDE.mdのチェックボックスを [x] に更新してください。**

**自己改善しつつ、気付いたこと/気をつけるべきことなどをCLAUDE.mdに追記/修正していく**

## プロジェクト概要

ネット小説執筆支援エディタです。特にネット小説（カクヨム、小説家になろう等）の執筆をサポートするための多機能エディタで、プロット、キャラクター、世界観、各話ごとのメモなどを一元管理し、執筆プロセスをスムーズにします。React、TypeScript、Tailwind CSS、Viteを使用して開発されます。

## 主要機能（TODO）

- エディタ: 本文を執筆できるシンプルなエディタ
- プロット管理: 物語のプロットを管理・編集
- あらすじ管理: 物語のあらすじを管理・編集
- 各話メモ: 各話ごとの筆者メモを管理・編集
- キャラクター管理: 各登場人物のプロフィール、他キャラとの関係性を記録
- 世界観管理: 物語の舞台となる世界の歴史、地理、文化などの設定をまとめる
- 自動保存: 自動的にローカルストレージに保存
- エクスポート: プロジェクトをカクヨム形式、なろう形式としてエクスポート
- 新規プロジェクト: 複数のプロジェクトを切り替えて作業

## プロジェクトのセットアップ（予定）

現在はREADME.mdのみが存在し、実装はこれから開始されます。

### 推奨される初期セットアップコマンド

```bash
# Viteプロジェクトの作成
npm create vite@latest . -- --template react-ts

# 依存関係のインストール
npm install

# Tailwind CSSのセットアップ
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p

# 開発用ライブラリ
npm install -D @types/react @types/react-dom eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin
```

### 推奨される開発コマンド

```bash
# 開発サーバーの起動
npm run dev

# ビルド
npm run build

# プレビュー
npm run preview

# リント
npm run lint

# 型チェック
npm run type-check

# テスト実行
npm run test

# テスト（ウォッチモード）
npm run test:watch

# テストカバレッジ
npm run test:coverage

# E2Eテスト
npm run test:e2e
```

## アーキテクチャ構造（推奨）

```
src/
├── components/     # 再利用可能なUIコンポーネント
├── features/       # 機能別のコンポーネント
│   ├── editor/
│   ├── plot/
│   ├── character/
│   └── worldbuilding/
├── hooks/          # カスタムフック
├── utils/          # ユーティリティ関数
├── types/          # TypeScript型定義
└── styles/         # グローバルスタイル
```

## 注意事項

- 日本語でのコミュニケーションを優先してください
- 小説執筆に特化した機能の実装を心がけてください
- ユーザビリティとパフォーマンスを重視してください
- **TypeScriptでは`any`型の使用を原則禁止してください。適切な型定義を行い、型安全性を保証してください**
- **package.jsonに`"type": "module"`を追加し、ESモジュールを使用しています**
- **新しいコンポーネントを作成する際は、必ずPrettierのフォーマットに準拠してください**
- **ファイルの最後には改行を含めてください（Prettierの設定により）**

## テスト戦略

### ユニットテスト

- **フレームワーク**: Vitest（Viteとの親和性が高い）
- **対象**: ユーティリティ関数、カスタムフック、純粋なコンポーネント
- **カバレッジ目標**: 80%以上

### 統合テスト

- **フレームワーク**: React Testing Library + Vitest
- **対象**: 機能単位でのコンポーネント統合、ユーザーインタラクション
- **重点項目**:
  - エディタの編集・保存機能
  - プロジェクト管理機能
  - データの永続化と復元

### E2Eテスト

- **フレームワーク**: Playwright
- **対象**: 主要なユーザーフロー
- **テストシナリオ**:
  - 新規プロジェクト作成から章の執筆まで
  - キャラクター・世界観設定の管理
  - エクスポート機能

### 開発ループでのテスト実行

1. **プレコミット**: リントと型チェック
2. **開発中**: ウォッチモードでユニットテスト自動実行
3. **プルリクエスト**: 全テストスイート実行
4. **デプロイ前**: E2Eテストを含む完全なテスト実行

## 気づいた点・実装時の注意事項

### バージョン管理機能の実装で学んだこと
- **型定義の重要性**: NodeJS.Timeoutなどの環境依存の型は、より汎用的な`ReturnType<typeof setTimeout>`を使用する
- **差分計算アルゴリズム**: 現在は簡易的な行単位の差分計算を実装。本番環境では、より高度なアルゴリズム（Myers差分アルゴリズムなど）の使用を検討すべき
- **ストレージ戦略**: バージョン履歴の保存にはサイズ制限があるため、古いバージョンの圧縮や外部ストレージへの移行を検討する必要がある
- **UIデザイン**: バージョン履歴の表示は、タイムライン形式とリスト形式の両方を提供することで、ユーザビリティが向上する

### 統計・分析機能の実装で学んだこと
- **ライブラリの互換性**: React 19との互換性問題により、Rechartsの代わりにCSSベースのシンプルなグラフ表示を実装
- **執筆セッション管理**: 執筆活動を自動的に追跡し、5分間操作がなければセッション終了とする設計
- **文体分析**: 日本語テキストの分析には、文字種別（漢字・ひらがな・カタカナ）の割合計算が有効
- **パフォーマンス**: 大量のテキストを分析する際は、useMemoを活用して再計算を最小限に抑える
- **空のインターフェース問題**: TypeScriptでは空のインターフェースを避け、型エイリアスを使用する

### 共同執筆機能の実装で学んだこと
- **データのエクスポート/インポート**: プロジェクトの共有は、完全なJSONデータとして実装し、新しいプロジェクトIDを生成することで衝突を回避
- **ファイル操作**: File APIを使用したファイルの読み込みと、Blobを使用したファイルのダウンロード機能の実装
- **エラーハンドリング**: JSONパースエラーや不正なデータ形式に対する適切なエラーメッセージの提供
- **UX設計**: クリップボードコピーとファイル保存の両方の方法を提供することで、ユーザーの利便性を向上

### プラグインシステムの実装で学んだこと
- **セキュリティ**: プラグインコードの実行にはサンドボックス環境が必要（現在は簡易版として実装）
- **プラグインAPI設計**: プラグインが必要とする機能を適切に抽象化し、権限システムで制御
- **イベントシステム**: プラグイン間の通信とフックの実装には、イベント駆動型のアーキテクチャが有効
- **型安全性**: unknownとタイプガードを使用して、プラグインとの通信における型安全性を確保
- **UI統合**: プラグイン管理UIは、インストール済み、マーケットプレイス、開発者向けの3つのタブで整理

### 音声入力・読み上げ機能の実装で学んだこと
- **Web Speech API**: 音声認識（SpeechRecognition）と音声合成（SpeechSynthesis）APIの活用
- **ブラウザ互換性**: ベンダープレフィックス（webkit）への対応と、APIサポートの確認
- **日本語対応**: 言語設定（ja-JP）と日本語音声の優先選択
- **UX設計**: 音声入力中の視覚的フィードバック（アニメーション、中間結果表示）
- **エラーハンドリング**: マイク権限、ネットワークエラーなど、各種エラーへの適切な対応
- **設定の永続化**: 読み上げ速度、ピッチ、音量などの設定をカスタマイズ可能に

### 執筆テンプレート機能の実装で学んだこと
- **テンプレート設計**: ジャンル別、カテゴリ別に整理された階層的なテンプレート構造
- **組み込みテンプレート**: 「英雄の旅」「異世界転生」など、定番の物語構造をテンプレート化
- **プロジェクト初期化**: テンプレート選択によるプロジェクトの初期値設定
- **拡張性**: カスタムテンプレートの作成・編集機能を想定した設計
- **UI/UX**: テンプレート選択画面でのフィルタリング、プレビュー機能
- **型安全性**: テンプレートの各要素に対する詳細な型定義により、実装時の安全性を確保

## 実装作業計画

### フェーズ1: プロジェクト基盤構築

- [x] Viteプロジェクトの初期化（React + TypeScript）
- [x] Tailwind CSSのセットアップ
- [x] ESLint、Prettierの設定
- [x] 基本的なディレクトリ構造の作成
- [x] package.jsonのスクリプト設定（dev, build, lint, type-check）
- [x] テスト環境のセットアップ（Vitest、React Testing Library、Playwright）

### フェーズ2: 基本UIとルーティング

- [x] React Routerの導入と設定
- [x] メインレイアウトコンポーネントの作成
- [x] ナビゲーションメニューの実装
- [x] 各機能のための基本的なページコンポーネント作成
- [x] 基本的なコンポーネントのユニットテスト作成

### フェーズ3: データモデルとストレージ

- [x] TypeScript型定義の作成（Project, Chapter, Character, Plot等）
- [x] ローカルストレージ管理のフックとユーティリティ
- [x] データの永続化とリストア機能
- [x] プロジェクト管理機能（新規作成、切り替え、削除）
- [x] ストレージ機能の統合テスト作成

### フェーズ4: エディタ機能

- [x] テキストエディタコンポーネントの実装
- [x] 自動保存機能
- [x] 文字数カウント機能
- [x] 章の管理（追加、編集、削除、並び替え）
- [x] エディタ機能のE2Eテスト作成

### フェーズ5: プロット・あらすじ管理

- [x] プロットエディタの実装
- [x] あらすじエディタの実装
- [x] 各話メモ機能の実装
- [x] プロットと本文の連携機能

### フェーズ6: キャラクター管理

- [x] キャラクター作成・編集フォーム
- [x] キャラクタープロフィール表示
- [x] キャラクター間の関係性マップ
- [x] キャラクター検索・フィルタリング

### フェーズ7: 世界観管理

- [x] 世界観設定の入力フォーム
- [x] カテゴリ別管理（地理、歴史、文化等）
- [x] 用語集機能
- [x] 設定資料の検索機能

### フェーズ8: エクスポート機能

- [x] カクヨム形式でのエクスポート
- [x] なろう形式でのエクスポート
- [x] プレーンテキストエクスポート
- [x] バックアップ機能（JSON形式）

### フェーズ9: UI/UX改善

- [x] ダークモード対応
- [x] レスポンシブデザインの最適化
- [x] キーボードショートカット
- [x] アクセシビリティ改善

### フェーズ10: パフォーマンス最適化と品質向上

- [x] コンポーネントの最適化（メモ化等）
- [x] 大規模プロジェクトでのパフォーマンステスト
- [x] テストカバレッジ80%以上の達成
- [x] CI/CDパイプラインの設定
- [x] パフォーマンス監視の実装

### フェーズ11: 統計・分析機能

- [x] 執筆セッション追跡システムの実装
- [x] 日次/週次/月次の執筆統計
- [x] 文体分析機能（漢字率、頻出単語など）
- [x] キャラクター登場頻度分析
- [x] プロジェクト進捗ダッシュボード
- [x] 統計データのエクスポート機能（JSON/CSV）
- [x] 執筆時間帯分析
- [x] グラフ表示（Recharts使用）
